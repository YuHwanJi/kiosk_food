<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>í‚¤ì˜¤ìŠ¤í¬ Â· ìŒì‹</title>
  <style>
    :root{
      --bg:#0b0b0f; --card:#141421; --muted:#a0a3b1; --txt:#f3f4f6; --pri:#7c5cff; --pri-2:#5f45d3; --ok:#19c37d; --bad:#ff6464;
      --gap:12px; --radius:16px; --shadow:0 8px 24px rgba(0,0,0,.25);
      --btn-h:56px; --font:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 600px at 10% -20%, #1b1b2a 0%, #0b0b0f 55%), var(--bg); color:var(--txt); font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    header{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:16px}
    h1{font-size:24px;margin:0}
    .badge{font-size:12px;color:#fff;background:linear-gradient(135deg, var(--pri), var(--pri-2));padding:6px 10px;border-radius:999px}
    .row{display:grid;grid-template-columns:1fr 360px;gap:16px}
    @media (max-width:980px){.row{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.08); border-radius:var(--radius); box-shadow:var(--shadow)}
    .card h2{margin:0 0 8px 0;font-size:18px}
    .pad{padding:16px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media (max-width:640px){.grid{grid-template-columns:repeat(2,1fr)}}
    .item{display:flex;flex-direction:column;gap:8px; padding:12px; min-height:130px; border-radius:14px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.06)}
    .item .title{font-weight:600}
    .item .price{color:var(--muted); font-size:14px}
    .item button{height:40px;border:0;border-radius:10px;background:linear-gradient(135deg, var(--pri), var(--pri-2)); color:#fff; cursor:pointer}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .btn{height:var(--btn-h);display:inline-flex;align-items:center;justify-content:center;padding:0 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:#fff;cursor:pointer}
    .btn.primary{background:linear-gradient(135deg, var(--pri), var(--pri-2)); border:0}
    .btn.ghost{background:transparent;border:1px dashed rgba(255,255,255,.18)}
    .btn.ok{background:linear-gradient(135deg, #19c37d, #0e8b5c); border:0}
    .btn.bad{background:linear-gradient(135deg, #ff6464, #d64a4a); border:0}
    .stack{display:flex;flex-direction:column;gap:12px}
    .cart-list, .history{width:100%; border-collapse:collapse}
    .cart-list th, .cart-list td, .history th, .history td{border-bottom:1px solid rgba(255,255,255,.08); padding:10px; text-align:left}
    .muted{color:var(--muted)}
    input, textarea{width:100%; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.12); color:#fff; padding:10px; border-radius:10px}
    .right{display:flex;justify-content:flex-end}
    .hint{font-size:12px;color:var(--muted)}
    .status-dot{display:inline-block;width:8px;height:8px;border-radius:999px;margin-right:6px; background:#6b7280}
    .status-dot.live{background:#22c55e; box-shadow:0 0 0 6px rgba(34,197,94,.15)}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);font-size:12px;color:#e5e7eb}
    .table-actions{display:flex;gap:6px}
    .nowrap{white-space:nowrap}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="display:flex;align-items:center;gap:10px">
        <h1>ğŸœ í‚¤ì˜¤ìŠ¤í¬(ìŒì‹)</h1>
        <span class="badge" id="liveBadge"><span class="status-dot" id="liveDot"></span>API ì—°ê²° í™•ì¸ ì¤‘â€¦</span>
      </div>
      <div class="toolbar">
        <button class="btn ghost" id="copySummaryBtn">ì£¼ë¬¸ë‚´ìš© ë³µì‚¬</button>
        <button class="btn" id="adminBtn">ê´€ë¦¬ì ëª¨ë“œ</button>
        <button class="btn" id="refreshBtn">ìƒˆë¡œê³ ì¹¨</button>
      </div>
    </header>

    <div class="row">
      <!-- ë©”ë‰´ -->
      <section class="card">
        <div class="pad stack">
          <h2>ë©”ë‰´</h2>
          <div class="grid" id="menuGrid"></div>
        </div>
      </section>

      <!-- ì¥ë°”êµ¬ë‹ˆ / ì£¼ë¬¸ -->
      <aside class="card">
        <div class="pad stack">
          <h2>ì¥ë°”êµ¬ë‹ˆ</h2>
          <table class="cart-list" id="cartTable">
            <thead><tr><th>í’ˆëª©</th><th class="nowrap">ìˆ˜ëŸ‰</th><th class="nowrap">ê¸ˆì•¡</th><th></th></tr></thead>
            <tbody></tbody>
            <tfoot><tr><td class="muted">ë©”ëª¨</td><td colspan="3"><input id="memoInput" placeholder="ë§µê¸°/ì˜µì…˜ ë“± ë©”ëª¨" /></td></tr></tfoot>
          </table>
          <div class="right muted">í•©ê³„: <span id="totalPrice" style="margin-left:6px">0</span>ì›</div>
          <div class="toolbar">
            <button class="btn bad" id="clearCartBtn">ì¥ë°”êµ¬ë‹ˆ ë¹„ìš°ê¸°</button>
            <button class="btn primary" id="submitOrderBtn">ì£¼ë¬¸í•˜ê¸°</button>
          </div>
          <div class="hint">ëª¨ë“  ì£¼ë¬¸ì€ ì„œë²„ì— ì €ì¥ë˜ì–´ ëˆ„êµ¬ë‚˜ ì£¼ë¬¸ ë‚´ì—­ì„ ë³¼ ìˆ˜ ìˆê³ , ì‚­ì œ/ë³µì›ì€ ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
        </div>
      </aside>
    </div>

    <!-- ì£¼ë¬¸ë‚´ì—­ -->
    <section class="card" style="margin-top:16px">
      <div class="pad">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <h2>ì£¼ë¬¸ ë‚´ì—­</h2>
          <div class="pill"><span class="status-dot live" id="liveDot2"></span><span id="envPill">ì•±: kiosk_food</span></div>
        </div>
        <table class="history" id="historyTable">
          <thead>
            <tr>
              <th>ì‹œê°„</th><th>ë‚´ìš©</th><th>í•©ê³„</th><th>ë©”ëª¨</th><th>ìƒíƒœ</th><th class="nowrap">ê´€ë¦¬</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    // ğŸ”§ í™˜ê²½ì„¤ì • â€” Renderì— ë°°í¬í•œ APIì˜ ë„ë©”ì¸ìœ¼ë¡œ êµì²´í•˜ì„¸ìš”.
    const API_BASE = "https://kiosk-orders-api.onrender.com"; // â† ì˜ˆ: https://kiosk-orders-api.onrender.com
    const APP_KEY  = "kiosk_food";
    // (ì„ íƒ) ê´€ë¦¬ì í† í°ì„ ë¯¸ë¦¬ ë„£ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ê°’ì— ë¬¸ìì—´ë¡œ ë„£ìœ¼ì„¸ìš”. ë¹ˆ ë¬¸ìì—´ì´ë©´ ìµœì´ˆ 1íšŒ ì…ë ¥ë°›ìŠµë‹ˆë‹¤.
    let ADMIN_TOKEN = "";

    // ğŸ½ï¸ ìŒì‹ ë©”ë‰´ (í•„ìš” ì‹œ ììœ ë¡­ê²Œ ìˆ˜ì •)
    const MENU = [
      { name: "ì«€ë“œê¸° íŠ€ê¹€", price: 3000 },
      { name: "ë™ì „ ì¥í¬",   price: 3000 },
      { name: "ë‚™ì§€ ë®ë°¥",   price: 3000 },
      { name: "ë²„í„° ì˜¤ì§•ì–´", price: 5000 },
      { name: "ê°ì¢… ê¼¬ì¹˜",   price: 3000 },
      { name: "ë–¡ë³¶ì´",     price: 3000 },
      { name: "íŒì½˜ ë§Œë‘",  price: 2000 },
      { name: "ê¹€ë§ì´ ë¯¸ë‹ˆ", price: 2000 },
      { name: "ê³ í–¥ ë§Œë‘",  price: 2000 },
      { name: "ì–¼ë°•ì‚¬",     price: 3000 },
      { name: "ì‚¬ì´ë‹¤+íŒŒì›Œì—ì´ë“œ", price: 3000 },
    ];

    // ğŸ›’ ì¥ë°”êµ¬ë‹ˆ ìƒíƒœ
    const cart = [];

    // ê³µí†µ ìœ í‹¸
    const fmt = (n)=> n.toLocaleString("ko-KR");
    const qs = (s)=> document.querySelector(s);
    const qsa= (s)=> Array.from(document.querySelectorAll(s));

    // API ë˜í¼
    async function api(path, opts={}){
      const url = `${API_BASE}${path}`;
      const headers = {'Content-Type':'application/json', ...(opts.headers||{})};
      const res = await fetch(url, {...opts, headers});
      if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      return res.json();
    }

    async function checkLive(){
      try{
        await api(`/health`);
        qs("#liveBadge").innerHTML = `<span class="status-dot live"></span>API ì—°ê²°ë¨`;
      }catch(e){
        qs("#liveBadge").innerHTML = `<span class="status-dot"></span>API ì˜¤ë¥˜`;
      }
    }

    // ë©”ë‰´ ë Œë”
    function renderMenu(){
      const grid = qs("#menuGrid");
      grid.innerHTML = "";
      MENU.forEach((m, idx)=>{
        const el = document.createElement("div");
        el.className="item";
        el.innerHTML = `
          <div class="title">${m.name}</div>
          <div class="price">${fmt(m.price)}ì›</div>
          <div style="display:flex;gap:8px;align-items:center">
            <input type="number" min="1" value="1" style="width:80px" id="qty-${idx}" />
            <button data-idx="${idx}">ë‹´ê¸°</button>
          </div>
        `;
        el.querySelector("button").addEventListener("click", ()=>{
          const qty = Math.max(1, parseInt(qs(`#qty-${idx}`).value||"1",10));
          addToCart(MENU[idx], qty);
        });
        grid.appendChild(el);
      });
    }

    // ì¥ë°”êµ¬ë‹ˆ
    function addToCart(item, qty){
      const found = cart.find(c=>c.name===item.name);
      if(found){ found.qty += qty; }
      else cart.push({name:item.name, price:item.price, qty});
      renderCart();
    }
    function removeFromCart(name){
      const i = cart.findIndex(c=>c.name===name);
      if(i>=0){ cart.splice(i,1); renderCart(); }
    }
    function clearCart(){
      cart.length=0; renderCart();
    }
    function calcTotal(){ return cart.reduce((s,c)=> s + c.price*c.qty, 0); }
    function renderCart(){
      const tbody = qs("#cartTable tbody");
      tbody.innerHTML = "";
      cart.forEach(c=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${c.name}</td>
          <td class="nowrap">x ${c.qty}</td>
          <td class="nowrap">${fmt(c.price*c.qty)}ì›</td>
          <td class="right"><button class="btn bad" style="height:36px" data-del="${c.name}">ì‚­ì œ</button></td>
        `;
        tbody.appendChild(tr);
      });
      qsa('[data-del]').forEach(btn=>{
        btn.addEventListener("click", ()=> removeFromCart(btn.dataset.del));
      });
      qs("#totalPrice").textContent = fmt(calcTotal());
    }

    // ì£¼ë¬¸ ì œì¶œ
    async function submitOrder(){
      if(cart.length===0){ alert("ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆì–´ìš”."); return; }
      const memo = qs("#memoInput").value.trim();
      const payload = {
        app: APP_KEY,
        items: cart.map(c=>({name:c.name, price:c.price, qty:c.qty})),
        total: calcTotal(),
        memo
      };
      try{
        await api(`/orders`, { method:"POST", body: JSON.stringify(payload) });
        alert("ì£¼ë¬¸ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
        clearCart(); qs("#memoInput").value="";
        await loadHistory();
      }catch(e){
        alert("ì£¼ë¬¸ ì‹¤íŒ¨: " + e.message);
      }
    }

    // ì£¼ë¬¸ ë‚´ì—­
    async function loadHistory(){
      try{
        const data = await api(`/orders?app=${APP_KEY}&includeDeleted=true`);
        const tbody = qs("#historyTable tbody");
        tbody.innerHTML = "";
        data.orders.forEach(o=>{
          const tr = document.createElement("tr");
          const when = new Date(o.createdAt || o.created_at || o.created).toLocaleString("ko-KR");
          const status = o.deletedAt || o.deleted_at ? "ì‚­ì œë¨" : "ì •ìƒ";
          tr.innerHTML = `
            <td class="nowrap">${when}</td>
            <td>${o.items.map(it=>`${it.name} x${it.qty}`).join(", ")}</td>
            <td class="nowrap">${fmt(o.total)}ì›</td>
            <td class="muted">${o.memo||""}</td>
            <td>${status}</td>
            <td>
              <div class="table-actions">
                <button class="btn bad" style="height:32px;display:${isAdmin()? 'inline-flex':'none'}" data-del="${o.id}">ì‚­ì œ</button>
                <button class="btn ok"  style="height:32px;display:${isAdmin()? 'inline-flex':'none'}" data-res="${o.id}">ë³µì›</button>
              </div>
            </td>
          `;
          tbody.appendChild(tr);
        });

        // ë°”ì¸ë”©
        qsa('[data-del]').forEach(btn=>{
          btn.addEventListener("click", ()=> adminDelete(btn.dataset.del));
        });
        qsa('[data-res]').forEach(btn=>{
          btn.addEventListener("click", ()=> adminRestore(btn.dataset.res));
        });
      }catch(e){
        console.error(e);
      }
    }

    // ê´€ë¦¬ì ëª¨ë“œ
    function isAdmin(){ return !!(localStorage.getItem("ADMIN_TOKEN") || ADMIN_TOKEN); }
    async function ensureAdmin(){
      if(!isAdmin()){
        const t = prompt("ê´€ë¦¬ì í† í°ì„ ì…ë ¥í•˜ì„¸ìš”");
        if(!t) return false;
        localStorage.setItem("ADMIN_TOKEN", t);
      }
      return true;
    }
    async function adminDelete(id){
      if(!(await ensureAdmin())) return;
      const token = localStorage.getItem("ADMIN_TOKEN") || ADMIN_TOKEN;
      try{
        await api(`/orders/${id}`, { method:"DELETE", headers:{ Authorization:`Bearer ${token}` } });
        await loadHistory();
      }catch(e){ alert("ì‚­ì œ ì‹¤íŒ¨: "+e.message); }
    }
    async function adminRestore(id){
      if(!(await ensureAdmin())) return;
      const token = localStorage.getItem("ADMIN_TOKEN") || ADMIN_TOKEN;
      try{
        await api(`/orders/${id}/restore`, { method:"POST", headers:{ Authorization:`Bearer ${token}` } });
        await loadHistory();
      }catch(e){ alert("ë³µì› ì‹¤íŒ¨: "+e.message); }
    }

    // ë³µì‚¬
    function buildSummary(){
      const rows = qsa("#historyTable tbody tr").slice(0, 20).map(tr=>{
        const tds = tr.querySelectorAll("td");
        return `â€¢ ${tds[0].innerText} â€” ${tds[1].innerText} / ${tds[2].innerText} / ${tds[4].innerText}`;
      });
      return `[${APP_KEY}] ìµœê·¼ ì£¼ë¬¸ ìš”ì•½\n` + rows.join("\n");
    }
    async function copySummary(){
      try{
        await navigator.clipboard.writeText(buildSummary());
        alert("ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì¹´í†¡ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”!");
      }catch(e){ alert("ë³µì‚¬ ì‹¤íŒ¨: "+e.message); }
    }

    // ì´ë²¤íŠ¸
    qs("#submitOrderBtn").addEventListener("click", submitOrder);
    qs("#clearCartBtn").addEventListener("click", clearCart);
    qs("#refreshBtn").addEventListener("click", loadHistory);
    qs("#copySummaryBtn").addEventListener("click", copySummary);
    qs("#adminBtn").addEventListener("click", async ()=>{
      if(await ensureAdmin()){ alert("ê´€ë¦¬ì ëª¨ë“œ í™œì„±í™”"); loadHistory(); }
    });

    // ì´ˆê¸°í™”
    (async function init(){
      qs("#envPill").textContent = `ì•±: ${APP_KEY}`;
      renderMenu(); renderCart();
      await checkLive();
      await loadHistory();
    })();
  </script>
</body>
</html>
