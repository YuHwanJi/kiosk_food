<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>키오스크 · 음식</title>
  <style>
    :root{
      --bg:#0b0b0f; --card:#141421; --muted:#a0a3b1; --txt:#f3f4f6; --pri:#7c5cff; --pri-2:#5f45d3; --ok:#19c37d; --bad:#ff6464;
      --gap:12px; --radius:16px; --shadow:0 8px 24px rgba(0,0,0,.25);
      --btn-h:56px; --font:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 600px at 10% -20%, #1b1b2a 0%, #0b0b0f 55%), var(--bg); color:var(--txt); font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    header{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:16px}
    h1{font-size:24px;margin:0}
    .badge{font-size:12px;color:#fff;background:linear-gradient(135deg, var(--pri), var(--pri-2));padding:6px 10px;border-radius:999px}
    .row{display:grid;grid-template-columns:1fr 360px;gap:16px}
    @media (max-width:980px){.row{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.08); border-radius:var(--radius); box-shadow:var(--shadow)}
    .card h2{margin:0 0 8px 0;font-size:18px}
    .pad{padding:16px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media (max-width:640px){.grid{grid-template-columns:repeat(2,1fr)}}
    .item{display:flex;flex-direction:column;gap:8px; padding:12px; min-height:130px; border-radius:14px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.06)}
    .item .title{font-weight:600}
    .item .price{color:var(--muted); font-size:14px}
    .item button{height:40px;border:0;border-radius:10px;background:linear-gradient(135deg, var(--pri), var(--pri-2)); color:#fff; cursor:pointer}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .btn{height:var(--btn-h);display:inline-flex;align-items:center;justify-content:center;padding:0 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:#fff;cursor:pointer}
    .btn.primary{background:linear-gradient(135deg, var(--pri), var(--pri-2)); border:0}
    .btn.ghost{background:transparent;border:1px dashed rgba(255,255,255,.18)}
    .btn.ok{background:linear-gradient(135deg, #19c37d, #0e8b5c); border:0}
    .btn.bad{background:linear-gradient(135deg, #ff6464, #d64a4a); border:0}
    .stack{display:flex;flex-direction:column;gap:12px}
    .cart-list, .history{width:100%; border-collapse:collapse}
    .cart-list th, .cart-list td, .history th, .history td{border-bottom:1px solid rgba(255,255,255,.08); padding:10px; text-align:left}
    .muted{color:var(--muted)}
    input, textarea{width:100%; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.12); color:#fff; padding:10px; border-radius:10px}
    .right{display:flex;justify-content:flex-end}
    .hint{font-size:12px;color:var(--muted)}
    .status-dot{display:inline-block;width:8px;height:8px;border-radius:999px;margin-right:6px; background:#6b7280}
    .status-dot.live{background:#22c55e; box-shadow:0 0 0 6px rgba(34,197,94,.15)}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);font-size:12px;color:#e5e7eb}
    .table-actions{display:flex;gap:6px}
    .nowrap{white-space:nowrap}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="display:flex;align-items:center;gap:10px">
        <h1>🍜 키오스크(음식)</h1>
        <span class="badge" id="liveBadge"><span class="status-dot" id="liveDot"></span>API 연결 확인 중…</span>
      </div>
      <div class="toolbar">
        <button class="btn ghost" id="copySummaryBtn">주문내용 복사</button>
        <button class="btn" id="adminBtn">관리자 모드</button>
        <button class="btn" id="refreshBtn">새로고침</button>
      </div>
    </header>

    <div class="row">
      <!-- 메뉴 -->
      <section class="card">
        <div class="pad stack">
          <h2>메뉴</h2>
          <div class="grid" id="menuGrid"></div>
        </div>
      </section>

      <!-- 장바구니 / 주문 -->
      <aside class="card">
        <div class="pad stack">
          <h2>장바구니</h2>
          <table class="cart-list" id="cartTable">
            <thead><tr><th>품목</th><th class="nowrap">수량</th><th class="nowrap">금액</th><th></th></tr></thead>
            <tbody></tbody>
            <tfoot><tr><td class="muted">메모</td><td colspan="3"><input id="memoInput" placeholder="맵기/옵션 등 메모" /></td></tr></tfoot>
          </table>
          <div class="right muted">합계: <span id="totalPrice" style="margin-left:6px">0</span>원</div>
          <div class="toolbar">
            <button class="btn bad" id="clearCartBtn">장바구니 비우기</button>
            <button class="btn primary" id="submitOrderBtn">주문하기</button>
          </div>
          <div class="hint">모든 주문은 서버에 저장되어 누구나 주문 내역을 볼 수 있고, 삭제/복원은 관리자만 가능합니다.</div>
        </div>
      </aside>
    </div>

    <!-- 주문내역 -->
    <section class="card" style="margin-top:16px">
      <div class="pad">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <h2>주문 내역</h2>
          <div class="pill"><span class="status-dot live" id="liveDot2"></span><span id="envPill">앱: kiosk_food</span></div>
        </div>
        <table class="history" id="historyTable">
          <thead>
            <tr>
              <th>시간</th><th>내용</th><th>합계</th><th>메모</th><th>상태</th><th class="nowrap">관리</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    // 🔧 환경설정 — Render에 배포한 API의 도메인으로 교체하세요.
    const API_BASE = "https://kiosk-orders-api.onrender.com"; // ← 예: https://kiosk-orders-api.onrender.com
    const APP_KEY  = "kiosk_food";
    // (선택) 관리자 토큰을 미리 넣고 싶다면 아래 값에 문자열로 넣으세요. 빈 문자열이면 최초 1회 입력받습니다.
    let ADMIN_TOKEN = "";

    // 🍽️ 음식 메뉴 (필요 시 자유롭게 수정)
    const MENU = [
      { name: "쫀드기 튀김", price: 3000 },
      { name: "동전 쥐포",   price: 3000 },
      { name: "낙지 덮밥",   price: 3000 },
      { name: "버터 오징어", price: 5000 },
      { name: "각종 꼬치",   price: 3000 },
      { name: "떡볶이",     price: 3000 },
      { name: "팝콘 만두",  price: 2000 },
      { name: "김말이 미니", price: 2000 },
      { name: "고향 만두",  price: 2000 },
      { name: "얼박사",     price: 3000 },
      { name: "사이다+파워에이드", price: 3000 },
    ];

    // 🛒 장바구니 상태
    const cart = [];

    // 공통 유틸
    const fmt = (n)=> n.toLocaleString("ko-KR");
    const qs = (s)=> document.querySelector(s);
    const qsa= (s)=> Array.from(document.querySelectorAll(s));

    // API 래퍼
    async function api(path, opts={}){
      const url = `${API_BASE}${path}`;
      const headers = {'Content-Type':'application/json', ...(opts.headers||{})};
      const res = await fetch(url, {...opts, headers});
      if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      return res.json();
    }

    async function checkLive(){
      try{
        await api(`/health`);
        qs("#liveBadge").innerHTML = `<span class="status-dot live"></span>API 연결됨`;
      }catch(e){
        qs("#liveBadge").innerHTML = `<span class="status-dot"></span>API 오류`;
      }
    }

    // 메뉴 렌더
    function renderMenu(){
      const grid = qs("#menuGrid");
      grid.innerHTML = "";
      MENU.forEach((m, idx)=>{
        const el = document.createElement("div");
        el.className="item";
        el.innerHTML = `
          <div class="title">${m.name}</div>
          <div class="price">${fmt(m.price)}원</div>
          <div style="display:flex;gap:8px;align-items:center">
            <input type="number" min="1" value="1" style="width:80px" id="qty-${idx}" />
            <button data-idx="${idx}">담기</button>
          </div>
        `;
        el.querySelector("button").addEventListener("click", ()=>{
          const qty = Math.max(1, parseInt(qs(`#qty-${idx}`).value||"1",10));
          addToCart(MENU[idx], qty);
        });
        grid.appendChild(el);
      });
    }

    // 장바구니
    function addToCart(item, qty){
      const found = cart.find(c=>c.name===item.name);
      if(found){ found.qty += qty; }
      else cart.push({name:item.name, price:item.price, qty});
      renderCart();
    }
    function removeFromCart(name){
      const i = cart.findIndex(c=>c.name===name);
      if(i>=0){ cart.splice(i,1); renderCart(); }
    }
    function clearCart(){
      cart.length=0; renderCart();
    }
    function calcTotal(){ return cart.reduce((s,c)=> s + c.price*c.qty, 0); }
    function renderCart(){
      const tbody = qs("#cartTable tbody");
      tbody.innerHTML = "";
      cart.forEach(c=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${c.name}</td>
          <td class="nowrap">x ${c.qty}</td>
          <td class="nowrap">${fmt(c.price*c.qty)}원</td>
          <td class="right"><button class="btn bad" style="height:36px" data-del="${c.name}">삭제</button></td>
        `;
        tbody.appendChild(tr);
      });
      qsa('[data-del]').forEach(btn=>{
        btn.addEventListener("click", ()=> removeFromCart(btn.dataset.del));
      });
      qs("#totalPrice").textContent = fmt(calcTotal());
    }

    // 주문 제출
    async function submitOrder(){
      if(cart.length===0){ alert("장바구니가 비어있어요."); return; }
      const memo = qs("#memoInput").value.trim();
      const payload = {
        app: APP_KEY,
        items: cart.map(c=>({name:c.name, price:c.price, qty:c.qty})),
        total: calcTotal(),
        memo
      };
      try{
        await api(`/orders`, { method:"POST", body: JSON.stringify(payload) });
        alert("주문이 전송되었습니다!");
        clearCart(); qs("#memoInput").value="";
        await loadHistory();
      }catch(e){
        alert("주문 실패: " + e.message);
      }
    }

    // 주문 내역
    async function loadHistory(){
      try{
        const data = await api(`/orders?app=${APP_KEY}&includeDeleted=true`);
        const tbody = qs("#historyTable tbody");
        tbody.innerHTML = "";
        data.orders.forEach(o=>{
          const tr = document.createElement("tr");
          const when = new Date(o.createdAt || o.created_at || o.created).toLocaleString("ko-KR");
          const status = o.deletedAt || o.deleted_at ? "삭제됨" : "정상";
          tr.innerHTML = `
            <td class="nowrap">${when}</td>
            <td>${o.items.map(it=>`${it.name} x${it.qty}`).join(", ")}</td>
            <td class="nowrap">${fmt(o.total)}원</td>
            <td class="muted">${o.memo||""}</td>
            <td>${status}</td>
            <td>
              <div class="table-actions">
                <button class="btn bad" style="height:32px;display:${isAdmin()? 'inline-flex':'none'}" data-del="${o.id}">삭제</button>
                <button class="btn ok"  style="height:32px;display:${isAdmin()? 'inline-flex':'none'}" data-res="${o.id}">복원</button>
              </div>
            </td>
          `;
          tbody.appendChild(tr);
        });

        // 바인딩
        qsa('[data-del]').forEach(btn=>{
          btn.addEventListener("click", ()=> adminDelete(btn.dataset.del));
        });
        qsa('[data-res]').forEach(btn=>{
          btn.addEventListener("click", ()=> adminRestore(btn.dataset.res));
        });
      }catch(e){
        console.error(e);
      }
    }

    // 관리자 모드
    function isAdmin(){ return !!(localStorage.getItem("ADMIN_TOKEN") || ADMIN_TOKEN); }
    async function ensureAdmin(){
      if(!isAdmin()){
        const t = prompt("관리자 토큰을 입력하세요");
        if(!t) return false;
        localStorage.setItem("ADMIN_TOKEN", t);
      }
      return true;
    }
    async function adminDelete(id){
      if(!(await ensureAdmin())) return;
      const token = localStorage.getItem("ADMIN_TOKEN") || ADMIN_TOKEN;
      try{
        await api(`/orders/${id}`, { method:"DELETE", headers:{ Authorization:`Bearer ${token}` } });
        await loadHistory();
      }catch(e){ alert("삭제 실패: "+e.message); }
    }
    async function adminRestore(id){
      if(!(await ensureAdmin())) return;
      const token = localStorage.getItem("ADMIN_TOKEN") || ADMIN_TOKEN;
      try{
        await api(`/orders/${id}/restore`, { method:"POST", headers:{ Authorization:`Bearer ${token}` } });
        await loadHistory();
      }catch(e){ alert("복원 실패: "+e.message); }
    }

    // 복사
    function buildSummary(){
      const rows = qsa("#historyTable tbody tr").slice(0, 20).map(tr=>{
        const tds = tr.querySelectorAll("td");
        return `• ${tds[0].innerText} — ${tds[1].innerText} / ${tds[2].innerText} / ${tds[4].innerText}`;
      });
      return `[${APP_KEY}] 최근 주문 요약\n` + rows.join("\n");
    }
    async function copySummary(){
      try{
        await navigator.clipboard.writeText(buildSummary());
        alert("복사되었습니다. 카톡에 붙여넣기 하세요!");
      }catch(e){ alert("복사 실패: "+e.message); }
    }

    // 이벤트
    qs("#submitOrderBtn").addEventListener("click", submitOrder);
    qs("#clearCartBtn").addEventListener("click", clearCart);
    qs("#refreshBtn").addEventListener("click", loadHistory);
    qs("#copySummaryBtn").addEventListener("click", copySummary);
    qs("#adminBtn").addEventListener("click", async ()=>{
      if(await ensureAdmin()){ alert("관리자 모드 활성화"); loadHistory(); }
    });

    // 초기화
    (async function init(){
      qs("#envPill").textContent = `앱: ${APP_KEY}`;
      renderMenu(); renderCart();
      await checkLive();
      await loadHistory();
    })();
  </script>
</body>
</html>
